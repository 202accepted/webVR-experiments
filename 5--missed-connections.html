<!doctype html>
<html>
<head>
   <title>5 - Missed Connections</title>
   <script src="bower_components/aframe/dist/aframe-v0.2.0.min.js"></script>
   <script src="bower_components/aframe-layout-component/dist/aframe-layout-component.min.js"></script>
   <script src="bower_components/aframe-template-component/dist/aframe-template-component.min.js"></script>
   <script src="bower_components/aframe-text-component/dist/aframe-text-component.min.js"></script>
   <script src="bower_components/jQuery/dist/jquery.min.js"></script>
   <script src="assets/5/data/nyc-data.js"></script>
</head>
<body>
   <!--
   Credits
   -->

   <!-- Scripts that must run before Aframe initializes -->
   <script type="text/javascript">

   </script>

   <a-scene id="main-scene" fog="type: exponential; color: #111; density:.00034">

      <!-- Block showing scene until these assets are loaded -->
      <a-assets>
         <!--
            Buildings
               10m/story
               15m/between buildings (approx 4 12" lanes)
               10m/width

               135//67.5
         -->
         <a-mixin id="bldg" geometry="primitive: box; depth: 30; height: 30; width: 30" material="roughness: 1; color: #404045"></a-mixin>
         <a-mixin id="bldg-h-sm" geometry="height: 21"></a-mixin>
         <a-mixin id="bldg-h-lg" geometry="height: 60"></a-mixin>
         <a-mixin id="bldg-w-lg" geometry=" width: 75"></a-mixin>
         <a-mixin id="notification" geometry="radius: 20; height: 20; width: 20; depth: 20;" material="color: #4CCCE5; opacity: .8"></a-mixin>

         <a-mixin id="font" text="size: .08; height: .02" material="color: #eee"></a-mixin>

         <a-mixin id="soundcube" ></a-mixin>
         <!-- for testing soundcubes placement add geometry="primitive: box; height: .5; width: .5; depth: .5"></a-mixin> -->
         <audio id="city-sounds"       src="assets/5/audio/city-sounds.mp3"></audio>
         <audio id="melancholy-piano"  src="assets/5/audio/melancholy-piano.mp3"></audio>
         <audio id="rain-sound"        src="assets/5/audio/rain-sound.mp3"></audio>
         <audio id="voices-murmur"     src="assets/5/audio/voices-murmur.mp3"></audio>

         <a-asset-item id="nyc" src="assets/5/manhattan+2001.obj" material="color: #111"></a-asset-item>

         <script id="humans" type="text/x-nunjucks-template">
            {% for x in range(0, 1) %}
               {% for z in range(0, 1) %}
                  <a-entity template="src: assets/5/templates/human.template; type: handlebars"
                            data-position="{{ x * 5 }} 0 {{ z * 5 }}"
                            data-humanID="5"></a-entity>
               {% endfor %}
            {% endfor %}
         </script>
         <script id="notifications" type="text/x-nunjucks-template">
            {% for x in range(-2, 2) %}
               {% for z in range(-2, 2) %}
                  <a-entity template="src: assets/5/templates/notifications.template; type: handlebars"
                            data-position="{{ x * 90 }} 0 {{ z * 90 + 40}}"></a-entity>
               {% endfor %}
            {% endfor %}
         </script>

          <script id="rain-sound" type="text/x-nunjucks-template">
            {% for x in range(-4, 4) %}
               {% for z in range(-2, 2) %}
                  <a-entity template="src: assets/5/audio/piano-sound.mp3; type: handlebars" data-position="{{ x * 90 }} 0 {{ z * 90 + 40}}" autoplay="true"></a-entity>
               {% endfor %}
            {% endfor %}
         </script>
      </a-assets>

      <!-- Global Settings -->
      <a-sky color="#111"></a-sky>
      <a-light type="ambient" color="#ccc" intensity=".1"></a-light>
      <a-light type="directional" color="#ccc" position="-1 1 0" intensity=".5"></a-light>
      <a-image position="0 -.025 0" height="2000" width="2000" rotation="90 0 0" src="assets/5/ground.png"></a-image>

      <!-- Human Camera -->
      <a-entity position="0 0 0" id="human-camera-position">
         <a-entity position="0 1.6 4">
            <a-camera id="human-camera" wasd-controls-enabled="true" look-controls-enabled="true" active="true">
               <a-entity cursor="fuse: false; maxDistance: 30; timeout: 500"
                  position="0 0 -1"
                  geometry="primitive: ring"
                  scale=".01 .01 .01"
                  material="color: white; shader: flat">
               </a-entity>
            </a-camera>
         </a-entity>
      </a-entity>

      <!-- Topographic Camera -->
      <a-entity position="0 2000 0" rotation="-90 0 0">
         <a-camera id="topology-camera" look-controls-enabled="true" active="false" fov="60" wasd-controls="enabled: true; acceleration: 8000; fly: true">
            <a-entity cursor="fuse: true; maxDistance: 30; timeout: 500"
               position="0 0 -1"
               geometry="primitive: ring"
               scale=".01 .01 .01"
               material="color: white; shader: flat">
            </a-entity>
         </a-camera>
      </a-entity>

      <!-- Sound Cubes -->
      <a-entity mixin="soundcube" position="0 -1 0" sound="src: assets/5/audio/voices-murmur.mp3; autoplay: true; loop: true"></a-entity>
      <a-entity mixin="soundcube" position="0 -4.5 0" sound="src: assets/5/audio/rain-sound.mp3; autoplay: true; loop: true; volume: .10"></a-entity>
      <a-entity mixin="soundcube" position="10 -3 0" sound="src: assets/5/audio/city-sounds.mp3; autoplay: true; loop: true; volume: .40"></a-entity>
      <a-entity mixin="soundcube" position="10 -3 0" sound="src: assets/5/audio/melancholy-piano.mp3; autoplay: true; loop: true; volume: .90"></a-entity>
      <a-entity id="skypiano" position="0 2200 0" sound="src: assets/5/audio/melancholy-piano.mp3; autoplay: true; loop: true; volume: 2.10"></a-entity>

      <!-- Fake City -->
      <a-entity template="src: assets/5/templates/city.template" position="22.5 0 0"></a-entity>

      <!-- Real City -->
      <!-- <a-obj-model src="#nyc" position="-300 -1 0"></a-obj-model> -->

      <!-- Humans -->
      <a-entity template="src: #humans" id="#humans"></a-entity>

      <!-- Notifications -->
      <a-entity template="src: #notifications"></a-entity>

   </a-scene>

   <script>
      /*
      *
      * Topology mode toggle
      *
      */
      document.onkeydown = checkKey;
      var cameramode = "human";
      function humanMode(){
         cameramode = "human";
         document.querySelector('#topology-camera').setAttribute("active","false");
         document.querySelector('#human-camera').setAttribute("active","true");
         // document.querySelector('#main-scene').setAttribute("fog","density",.01);
      }
      function topologyMode(){
         cameramode = "topology";
         document.querySelector('#topology-camera').setAttribute("active","true");
         document.querySelector('#human-camera').setAttribute("active","false");
         // document.querySelector('#main-scene').setAttribute("fog","density",.007);
      }

      /*
      Click mode toggle
      */
      var animationclickmode = false;
      var textInit = false;
      function checkKey(e) {

         e = e || window.event;
         // toggle topology mode
         if(e.keyCode == '71') { // the letter g
            if(cameramode == "topology"){
               humanMode();
            } else {
               topologyMode();
            }
         }
         // toggle click mode
         if(e.keyCode == '67') { // the letter c
            animationclickmode = !animationclickmode;
         }
         // welcome room
          else if (e.keyCode == '49') { // key 1
               document.querySelector('#human-camera').setAttribute("rotation","-2.0626480624709576 -404.393611803335 0");
               document.querySelector('#human-camera').setAttribute("position","-2.2701610252157285 0 2.4709360834056313");
          }
         else if (e.keyCode == '66') {
            if(textInit == false){
               setHumans();
               textInit = true;
            }
          }

      }

      /*
      Set humans up after load with 'b'
      */
      function setHumans(){
         var humanTextContainer = $('.human').find('#human-text-container');
         var humanText = postData;
         console.log(humanTextContainer);
         $.each(humanTextContainer, function(i, val){
            setHuman(i, humanTextContainer, humanText);
         })
      }

      /*
      Set single human up
      */
      function setHuman(humanID, humanTextContainer, humanText){
         $.each(humanTextContainer, function(i, val){
            var splitBySpace = humanText.posts[i].bodyCleaned.split(" ");
            console.log(splitBySpace);
            var lineHeight = .2;
            var lineHeightRel = 0;
            var textLine = 0;
            while (textLine <= splitBySpace.length){
               var word1 = splitBySpace[textLine];
               var word2 = splitBySpace[textLine + 2];
               var word3 = splitBySpace[textLine + 3];
               var word4 = splitBySpace[textLine + 4];
               if(word1 == undefined){
                  word1 = '';
               }
               if(word2 == undefined){
                  word2 = '';
               }
               if(word3 == undefined){
                  word3 = '';
               }
               if(word4 == undefined){
                  word4 = '';
               }
               $(this).append('<a-entity mixin="font" text="text: ' + word1 + ' ' + word2 + ' ' + word3 + ' ' + word4 + '" position="-0.5 ' + lineHeightRel + ' 0"></a-entity>');
               lineHeightRel -= lineHeight;
               textLine += 5;
            }
            var textContainerHeight = lineHeight * (textLine / 4);
            $(this).attr('position', '0 ' + textContainerHeight + ' 0')
         })
      }



   </script>
   </body>
</html>
