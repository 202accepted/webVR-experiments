<!doctype html>
<html>
<head>
   <title>6 - Head Tracked Rotations</title>
   <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no,user-scalable=no,maximum-scale=1">
   <script src="bower_components/aframe/dist/aframe-v0.2.0.min.js"></script>
   <script src="bower_components/Keypress/keypress.js"></script>
</head>
<body>

   <a-scene id="main-scene" fog="type: exponential; color: #d81159; density: .05">

      <!--
         Dark Blue:  006ba6
         Blue:       0496ff
         Yellow:     ffbc42
         Pink:       d81159
         Plum:       8f2d56
      -->

      <a-assets>
         <a-mixin id="box" material="color: #0496ff" geometry="height: .3; width: .3; depth: .3"></a-mixin>
         <a-mixin id="torus" material="color: #ffbc42" geometry="radius: .02; radius-tubular: .005"></a-mixin>
      </a-assets>

      <!-- Global Settings -->
      <a-sky color="#d81159"></a-sky>
      <a-light type="ambient" color="#fff" intensity=".1"></a-light>
      <a-light type="directional" color="#fff" position="0 0 0" intensity=".5"></a-light>
      <a-image id="ground" position="0 -.025 0" height="300" width="300" rotation="90 0 0" src="assets/5/ground.png"></a-image>

      <!-- Human Camera -->
      <a-entity position="0 1.7 1.1">
         <a-camera id="human-camera" wasd-controls-enabled="true" look-controls-enabled="true" rotation="1 25 62" active="true">
            <a-entity position="0 0 -1.4" rotation="0 0 0" class="target">
               <a-box mixin="box" position="0 0 0"  rotation="15 20 50"></a-box>
               <a-box mixin="box" position="-.6 0 0" rotation="15 20 50"></a-box>
               <a-box mixin="box" position=".6 0 0"  rotation="15 20 50"></a-box>
               <a-torus mixin="torus" position="0 0 -.21"></a-torus>
            </a-entity>
         </a-camera>
      </a-entity>
      <a-entity position="0 1.7 -.3" rotation="0 0 0" class="target">
         <a-box mixin="box" material="opacity: 0" position="0 0 0"  rotation="15 20 50"></a-box>
         <a-box mixin="box" material="opacity: 0" position="-.6 0 0" rotation="15 20 50"></a-box>
         <a-box mixin="box" material="opacity: 0" position=".6 0 0"  rotation="15 20 50"></a-box>
         <a-torus mixin="torus" material="opacity: 0" position="0 0 -.21"></a-torus>
      </a-entity>

   </a-scene>

   <script>
      var scene = document.querySelector('a-scene');
      scene.addEventListener('loaded', function(){
         // Initially set the camera object
         setCameraAttributes();

         // Setup observer
         setObserver();
      });

      // Create a camera object
      var camera = {
         el: document.querySelector('#human-camera'),
         x: 0,
         y: 0,
         z: 0,
         a: 0,
         b: 0,
         c: 0
      }
      // Set target object
      var target = document.getElementsByClassName('target');
      // Set active target
      var activeTarget = target[0];
      var defaultMutation = 4;

      var keyListener = new window.keypress.Listener();
      keyListener.simple_combo('c', function(){
         setCameraAttributes();
         console.log(camera);
      });
      keyListener.simple_combo('t', function(){
         toggleTarget();
      });
      keyListener.simple_combo('0', function(){
         setObserver(defaultMutation);
      });
      keyListener.simple_combo('1', function(e){
         setObserver(1);
      });
      keyListener.simple_combo('2', function(){
         setObserver(2);
      });
      keyListener.simple_combo('3', function(){
         setObserver(3);
      });
      keyListener.simple_combo('4', function(){
         setObserver(4);
      });
      keyListener.simple_combo('5', function(){
         setObserver(5);
      });
      var observer = undefined;
      function setObserver(mutationType){
         // disconnect existing observer
         if(observer != undefined)
            observer.disconnect();

         if(mutationType == undefined)
            mutationType = defaultMutation;
         // Observe the changes to the camera
         var observer = new MutationObserver(function(mutations){
            mutations.forEach(function(mutation){
               setCameraAttributes();
               updateTarget(activeTarget, mutationType);
            });
         });

         // I don't know what I'm doing here
         var observerConfig = {
            attributes:    true,
            childList:     true,
            characterData: true
         }
         // Set up the observer
         observer.observe(camera.el, observerConfig);
      }

      function setCameraAttributes(){

         var humanCameraPosition = camera.el.getAttribute('position');
         camera.x = humanCameraPosition.x;
         camera.y = humanCameraPosition.y;
         camera.z = humanCameraPosition.z;

         var humanCameraRotation = camera.el.getAttribute('rotation');
         camera.a = humanCameraRotation.x;
         camera.b = humanCameraRotation.y;
         camera.c = humanCameraRotation.z;

      }

      // Sets opacity
      function setOpacityOfChildren(el, opacity){
         for(var activeChild in el){
            if(typeof el[activeChild] == 'object'){
               el[activeChild].setAttribute('material', 'opacity: ' + opacity);
            }
         }
      }

      // Toggles the rotation target
      function toggleTarget(targetSetting){

         setOpacityOfChildren(activeTarget.children, 0);

         if(targetSetting == undefined){
            if(activeTarget == target[0]){
               activeTarget = target[1];
            }else if(activeTarget == target[1]){
               activeTarget = target[0];
            }
            else{
               console.log("halp");
            }
         }else{
            activeTarget = target[targetSetting];
         }

         setOpacityOfChildren(activeTarget.children, 1);
      }

      function cameraRotation(camera, cameraScalar){
         return camera.a*cameraScalar[0] + " " + camera.b*cameraScalar[1] + " " + camera.c*cameraScalar[2];
      }

      function updateTarget(target, mutationType){
         if(mutationType == undefined)
            mutationType = defaultMutation;
         switch (mutationType){
            // Move position x
            case 1:
               target.setAttribute('position', camera.x + " 0 0");
               break;
            // Rotate x
            case 2:
               target.setAttribute('rotation', camera.z*60 + " 0 0");
               break;
            // Rotate inverse to human camera rotation
            case 3:
               target.setAttribute('rotation', cameraRotation(camera, [1, 1, 1]));
               break;
            // Reasonable magic numbers, 1/4 of horizontal rotation, 1/3 of vertical rotation
            case 4:
               target.setAttribute('rotation', cameraRotation(camera, [-4, -3, 1]));
               break;
               target.setAttribute('rotation', cameraRotation(camera, [4, 3, 1]));
               break;
            default:
               break;
         }
      }

   </script>
   </body>
</html>
